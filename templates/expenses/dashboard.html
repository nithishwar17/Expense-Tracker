{% extends "expenses/base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3>Dashboard</h3>
    <div class="small text-muted">Overview of your expenses</div>
  </div>

  <div class="d-flex align-items-center">
    <form method="get" class="d-flex align-items-center me-3" style="gap:8px">
      <input class="form-control" name="q" placeholder="Search expenses..." value="{{ q|default:'' }}">
      <input class="form-control" type="date" name="from" value="{{ request.GET.from }}">
      <input class="form-control" type="date" name="to" value="{{ request.GET.to }}">
      <button class="btn btn-outline-secondary" type="submit">Apply</button>
    </form>

    <div>
      <a class="btn btn-outline-primary btn-filter" href="?filter=today">Today</a>
      <a class="btn btn-outline-primary btn-filter" href="?filter=week">This Week</a>
      <a class="btn btn-outline-primary btn-filter" href="?filter=month">This Month</a>
      <a class="btn btn-outline-secondary btn-filter" href="{% url 'expenses:dashboard' %}">All</a>
    </div>
  </div>
</div>

<!-- Budget & Insights Row -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="card-exp">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <div style="font-weight:700; font-size:1rem">Monthly Budget</div>
          <div class="small text-muted">Current month overview</div>
        </div>
        {% if current_budget %}
          <div class="text-end">
            <div style="font-weight:700">₹{{ current_budget.amount }}</div>
            <div class="small text-muted">Budget</div>
          </div>
        {% else %}
          <div class="text-end small text-muted">No budget set</div>
        {% endif %}
      </div>

      {% if current_budget %}
      <div style="margin-top:12px">
        <div class="small text-muted">Spent: ₹{{ spent_this_month }} • Used: {{ budget_pct }}%</div>
        <div class="progress" style="height:12px; margin-top:8px; border-radius:8px; overflow:hidden;">
          <div class="progress-bar" role="progressbar" style="width: {{ budget_pct }}%; background: var(--accent);" aria-valuenow="{{ budget_pct }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        {% if budget_pct >= 100 %}
          <div class="small text-danger" style="margin-top:8px;">You have exceeded your budget for this month.</div>
        {% elif budget_pct >= 90 %}
          <div class="small text-warning" style="margin-top:8px;">Warning: You have used 90%+ of your budget this month.</div>
        {% endif %}
      </div>
      {% else %}
      <div class="small text-muted" style="margin-top:12px;">Create a budget on the Budgets page to track monthly spending.</div>
      {% endif %}
    </div>
  </div>

  <div class="col-md-6">
    <div class="card-exp">
      <div style="font-weight:700">Insights</div>
      <div class="small text-muted">Helpful observations about your spending</div>

      <ul class="mt-3" style="padding-left:16px;">
        {% if insights %}
          {% for it in insights %}
            <li class="small" style="margin-bottom:6px;">{{ it }}</li>
          {% endfor %}
        {% else %}
          <li class="small text-muted">No insights yet — add some expenses to generate insights.</li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>

<!-- Main content row -->
<div class="row">
  <div class="col-md-4">
    <div class="total-box">Total: ₹{{ total }}</div>

    <ul class="list-unstyled">
      {% for exp in expenses %}
      <li class="mb-2">
        <div class="card-exp d-flex justify-content-between align-items-center">
          <div>
            <div style="font-weight:700">{{ exp.description }}</div>
            <div class="small text-muted">{{ exp.date }} • {{ exp.category }}</div>
          </div>
          <div class="text-end">
            <div style="font-weight:700">₹{{ exp.amount }}</div>
            <div style="margin-top:6px">
              <a href="{% url 'expenses:edit' exp.pk %}" class="btn btn-link">Edit</a>
              <a href="{% url 'expenses:delete' exp.pk %}" class="btn btn-link text-danger">Delete</a>
            </div>
          </div>
        </div>
      </li>
      {% empty %}
      <li><div class="card-exp">No expenses yet.</div></li>
      {% endfor %}
    </ul>

    {% if page_obj %}
    <nav aria-label="Page navigation">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?{% if q %}q={{ q }}&{% endif %}page={{ page_obj.previous_page_number }}{% if filter_by %}&filter={{ filter_by }}{% endif %}">Previous</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Previous</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?{% if q %}q={{ q }}&{% endif %}page={{ page_obj.next_page_number }}{% if filter_by %}&filter={{ filter_by }}{% endif %}">Next</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>

  <div class="col-md-8">
    <div class="chart-card">
      <canvas id="categoryChart" style="width:100%;height:100%;max-height:360px;"></canvas>
    </div>
  </div>
</div>

<script>
  const labels = {{ labels|safe }};
  const data = {{ data|safe }};
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const categoryChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{ data: data }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } }
    }
  });
  window.addEventListener('resize', () => categoryChart.resize());
</script>

{% endblock %}
